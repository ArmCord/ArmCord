name: macOS signed build
on: 
  push:
    branches:
      - macOS-codesign

env:
  FORCE_COLOR: true

jobs:
    build-mac:
        runs-on: macos-14

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - uses: pnpm/action-setup@v2 # Install pnpm using packageManager key in package.json

            - name: Use Node.js 22
              uses: actions/setup-node@v2
              with:
                  node-version: 22
                  cache: "pnpm"
            - name: List version of OpenSSL
              run: brew install openssl@3 && brew link openssl@3
            - name: Install Node dependencies
              run: pnpm install

            - name: Install Electron-Builder
              run: pnpm install -g electron-builder
            - uses: apple-actions/import-codesign-certs@v3
              with: 
                p12-file-base64: ${{ secrets.MACOS_SIGN_CERT }}
                p12-password: ${{ secrets.MACOS_SIGN_PASS }}
            - name: Build
              run: pnpm run build && electron-builder --macos --x64 --arm64
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: List all files in the dist directory
              run: ls -l dist
            - name: Delete unpacked builds
              run: rm -rf dist/macos-unpacked

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ArmCordMac
                  path: dist/
